'use client';

import { createContext, useContext, useEffect, useMemo, useState } from 'react';

type Lang = 'de' | 'en';

type I18nContextValue = {
  lang: Lang;
  toggleLanguage: () => void;
  t: (key: string, fallback?: string) => string;
};

const translations: Record<Lang, Record<string, string>> = {
  de: {
    'nav.goals': 'Sparziele',
    'nav.analysis': 'Analyse',
    'nav.history': 'Verlauf',
    'nav.input': 'Eingabe',
    'nav.switchLang': 'Sprache',
    'meta.title': 'SmartBudgetAI - Dein persönlicher Finanzcoach',
    'meta.desc':
      'Intelligente Ausgabenanalyse mit KI-gestützter Impulserkennung und Sparzielen',
    'page.home.title': 'Finanzcoach Chat',
    'page.home.subtitle': 'Behalte deine Sparziele im Blick.',
    'page.home.input.placeholder': 'Schreibe deine Nachricht...',
    'page.home.send': 'Senden',
    'page.home.example': 'Beispiel: "Ich möchte 2000 CHF bis nächsten Sommer für Ferien sparen"',
    'page.home.loading': 'Analysiere...',
    'page.home.welcome':
      'Hallo! Ich bin dein persönlicher Finanzcoach. Ich helfe dir, deine Ausgaben zu analysieren und Sparziele zu erreichen. Was möchtest du heute besprechen?',
    'page.home.assistantError': 'Entschuldigung, da ist etwas schiefgelaufen.',
    'goals.title': 'Deine Sparziele',
    'goals.empty': 'Du hast noch keine Sparziele. Erzähle dem Coach, was du sparen möchtest!',
    'goals.progress': 'Fortschritt',
    'goals.rules': 'Deine Regeln:',
    'goals.by': 'bis',
    'goals.daysLeft.prefix': 'Noch',
    'goals.daysLeft.suffix': 'Tage',
    'analyse.loading': 'Lade Analyse...',
    'analyse.title': 'Deine Ausgaben Analyse',
    'analyse.subtitle': 'Überblick über dein aktuelles Budget und Ausgabeverhalten',
    'analyse.timeframe': 'Zeitraum',
    'analyse.timeframe.month': 'Aktueller Monat',
    'analyse.timeframe.year': 'Ganzes Jahr',
    'analyse.timeframe.custom': 'Eigener Zeitraum',
    'analyse.from': 'Von',
    'analyse.to': 'Bis',
    'analyse.range.invalid': 'Bitte gültigen Zeitraum wählen.',
    'analyse.applyRange': 'Zeitraum anwenden',
    'analyse.budgetMode': 'Budget-Berechnung',
    'analyse.budgetMode.auto': 'Automatisch (Lohnhistorie)',
    'analyse.budgetMode.manual': 'Manuell (Budget-Dialog)',
    'analyse.budget.remaining': 'Verbleibend',
    'analyse.budget.over': 'Überzogen',
    'analyse.budgetTitle': 'Budgetübersicht',
    'analyse.used': 'Genutzt (Ausgaben)',
    'analyse.basis': 'Basis',
    'analyse.manual': 'manuell',
    'analyse.salaryBasis': 'Lohnsumme im Zeitraum',
    'analyse.patterns': 'Erkannte Muster & Nudges',
    'analyse.impulses': 'Impulskäufe',
    'analyse.impulseBadge': 'Impulskauf erkannt',
    'analyse.impulseJustify.label': 'Impulskauf begründen',
    'analyse.impulseJustify.placeholder': 'Warum war dieser Kauf notwendig oder geplant?',
    'analyse.impulseJustify.submit': 'Begründung senden',
    'analyse.goals': 'Sparziele',
    'analyse.addDeposit': 'Einzahlung',
    'analyse.depositPlaceholder': 'Betrag in CHF',
    'analyse.depositHint': 'Erhöht den aktuellen Sparstand.',
    'analyse.goalLabel': 'Ziel',
    'analyse.current': 'Aktuell',
    'analyse.progress': 'Fortschritt',
    'analyse.target': 'Ziel',
    'analyse.rules': 'Verhaltensregeln:',
    'analyse.byCategory': 'Ausgaben nach Kategorie',
    'analyse.save': 'Speichern',
    'analyse.cancel': 'Abbrechen',
    'analyse.delete': 'Löschen',
    'eingabe.title': 'Transaktionen erfassen',
    'eingabe.subtitle':
      'Einzelne Transaktionen manuell oder mehrere per CSV hochladen und automatisch klassifizieren lassen.',
    'eingabe.csv': 'CSV Upload',
    'eingabe.csv.drop': 'Datei hier ablegen oder klicken, um auszuwählen',
    'eingabe.csv.hint': 'Unterstützt CSV mit Kopfzeile. Maximale Größe 5 MB.',
    'eingabe.csv.selected': 'Ausgewählte Datei',
    'eingabe.csv.uploading': 'Lade hoch...',
    'eingabe.csv.result': 'Import-Ergebnis',
    'eingabe.csv.success': 'Erfolgreich',
    'eingabe.csv.failed': 'Fehlgeschlagen',
    'eingabe.csv.processed': 'Verarbeitet',
    'eingabe.csv.example': 'Beispiel CSV',
    'eingabe.manual.saved': 'Manuelle Erfassung gespeichert.',
    'eingabe.form.title': 'Neue Transaktion',
    'eingabe.form.subtitle': 'Erfasse manuell oder nutze den CSV-Upload auf dieser Seite.',
    'eingabe.form.date': 'Datum',
    'eingabe.form.merchant': 'Händler / Geschäft *',
    'eingabe.form.merchant.placeholder': 'z.B. Coop, Zalando, SBB',
    'eingabe.form.amount': 'Betrag (CHF) *',
    'eingabe.form.rawCategory': 'Kategorie (optional)',
    'eingabe.form.rawCategory.placeholder': 'z.B. Shopping, Lebensmittel',
    'eingabe.form.rawCategory.hint': 'Die KI klassifiziert automatisch, aber du kannst hier einen Hinweis geben.',
    'eingabe.form.justification': 'Begründung (optional)',
    'eingabe.form.justification.placeholder': 'Warum hast du diesen Kauf getätigt?',
    'eingabe.form.goal': 'Zuweisung zum Sparziel (optional)',
    'eingabe.form.goal.placeholder': 'Sparziel auswählen (optional)',
    'eingabe.form.allocate.placeholder': 'Betrag als Einzahlung (CHF)',
    'eingabe.form.allocate.hint': 'Optional: Verbucht einen Betrag direkt auf das ausgewählte Sparziel.',
    'eingabe.form.cancel': 'Abbrechen',
    'eingabe.form.submit': 'Transaktion erfassen',
    'eingabe.form.loading': 'Analysiere...',
    'verlauf.title': 'Verlauf',
    'verlauf.subtitle': 'Alle Transaktionen mit KI-Erläuterung und Filtermöglichkeiten.',
    'verlauf.loading': 'Lade Transaktionen...',
    'verlauf.newTransaction': 'Neue Transaktion',
    'verlauf.filters': 'Filter',
    'verlauf.search': 'Suche',
    'verlauf.search.placeholder': 'z.B. Migros, Netflix...',
    'verlauf.category': 'Kategorie',
    'verlauf.category.all': 'Alle Kategorien',
    'verlauf.type': 'Typ',
    'verlauf.type.all': 'Alle',
    'verlauf.type.income': 'Einnahmen',
    'verlauf.type.expense': 'Ausgaben',
    'verlauf.type.expenseOnly': 'Nur Ausgaben (-)',
    'verlauf.type.incomeOnly': 'Nur Einnahmen (+)',
    'verlauf.sort': 'Sortieren nach',
    'verlauf.sort.dateDesc': 'Datum (neu → alt)',
    'verlauf.sort.dateAsc': 'Datum (alt → neu)',
    'verlauf.sort.amountDesc': 'Betrag (hoch → tief)',
    'verlauf.sort.amountAsc': 'Betrag (tief → hoch)',
    'verlauf.budget': 'Monatsbudget',
    'verlauf.budget.set': 'Budget setzen',
    'verlauf.budget.flex': 'Monatliches Budget (flexibel)',
    'verlauf.budget.used': 'Verbraucht',
    'verlauf.budget.remaining': 'Verbleibend',
    'verlauf.budget.over': 'Überzogen',
    'verlauf.budget.dialog.title': 'Budget anpassen',
    'verlauf.budget.dialog.input': 'Budget in CHF',
    'verlauf.save': 'Speichern',
    'verlauf.cancel': 'Abbrechen',
    'verlauf.table.empty': 'Keine Transaktionen gefunden.',
    'verlauf.table.emptyState': 'Noch keine Transaktionen erfasst.',
    'verlauf.table.addFirst': 'Erste Transaktion hinzufügen',
    'verlauf.table.noResults': 'Keine Transaktionen für diese Filter.',
    'verlauf.table.saving': 'Speichere...',
    'verlauf.impulseJustify.label': 'Impulskauf begründen',
    'verlauf.impulseJustify.submit': 'Begründung senden',
    'verlauf.impulseJustify.placeholder': 'Warum war dieser Kauf notwendig oder geplant?',
    'verlauf.impulseBadge': 'Impulskauf',
    'verlauf.table.changeCategory': 'Kategorie ändern',
    'verlauf.dateRange.from': 'Von',
    'verlauf.dateRange.to': 'Bis',
    'verlauf.clearFilters': 'Filter zurücksetzen',
    'verlauf.amount': 'Betrag',
    'verlauf.basis': 'Basis',
    'verlauf.manual': 'manuell',
    'verlauf.salary': 'Lohn (60%)',
    'verlauf.auto': 'Auto (Lohnbasis)',
  },
  en: {
    'nav.goals': 'Goals',
    'nav.analysis': 'Analysis',
    'nav.history': 'History',
    'nav.input': 'Input',
    'nav.switchLang': 'Language',
    'meta.title': 'SmartBudgetAI - Your personal finance coach',
    'meta.desc': 'Intelligent spend analysis with AI impulse detection and savings goals',
    'page.home.title': 'Finance Coach Chat',
    'page.home.subtitle': 'Keep your savings goals on track.',
    'page.home.input.placeholder': 'Type your message...',
    'page.home.send': 'Send',
    'page.home.example': 'Example: "I want to save 2000 CHF for a holiday next summer"',
    'page.home.loading': 'Analyzing...',
    'page.home.welcome':
      'Hi! I am your personal finance coach. I help you analyze spending and reach your savings goals. What would you like to discuss today?',
    'page.home.assistantError': 'Sorry, something went wrong.',
    'goals.title': 'Your savings goals',
    'goals.empty': 'You have no savings goals yet. Tell the coach what you want to save for!',
    'goals.progress': 'Progress',
    'goals.rules': 'Your rules:',
    'goals.by': 'by',
    'goals.daysLeft.prefix': '',
    'goals.daysLeft.suffix': 'days left',
    'analyse.loading': 'Loading analysis...',
    'analyse.title': 'Spending analysis',
    'analyse.subtitle': 'Overview of your current budget and spending behaviour',
    'analyse.timeframe': 'Timeframe',
    'analyse.timeframe.month': 'Current month',
    'analyse.timeframe.year': 'Full year',
    'analyse.timeframe.custom': 'Custom range',
    'analyse.from': 'From',
    'analyse.to': 'To',
    'analyse.range.invalid': 'Please choose a valid range.',
    'analyse.applyRange': 'Apply range',
    'analyse.budgetMode': 'Budget calculation',
    'analyse.budgetMode.auto': 'Automatic (salary history)',
    'analyse.budgetMode.manual': 'Manual (budget dialog)',
    'analyse.budget.remaining': 'Remaining',
    'analyse.budget.over': 'Over budget',
    'analyse.budgetTitle': 'Budget overview',
    'analyse.used': 'Used (expenses)',
    'analyse.basis': 'Basis',
    'analyse.manual': 'manual',
    'analyse.salaryBasis': 'Salary sum in range',
    'analyse.patterns': 'Patterns & Nudges',
    'analyse.impulses': 'Impulse buys',
    'analyse.impulseBadge': 'Impulse detected',
    'analyse.impulseJustify.label': 'Explain impulse buy',
    'analyse.impulseJustify.placeholder': 'Why was this purchase necessary or planned?',
    'analyse.impulseJustify.submit': 'Submit justification',
    'analyse.goals': 'Savings goals',
    'analyse.addDeposit': 'Deposit',
    'analyse.depositPlaceholder': 'Amount in CHF',
    'analyse.depositHint': 'Increases the current savings amount.',
    'analyse.goalLabel': 'Goal',
    'analyse.current': 'Current',
    'analyse.progress': 'Progress',
    'analyse.target': 'Target',
    'analyse.rules': 'Rules:',
    'analyse.byCategory': 'Spending by category',
    'analyse.save': 'Save',
    'analyse.cancel': 'Cancel',
    'analyse.delete': 'Delete',
    'eingabe.title': 'Capture Transactions',
    'eingabe.subtitle':
      'Enter single transactions manually or upload multiple via CSV and let the AI classify them.',
    'eingabe.csv': 'CSV upload',
    'eingabe.csv.drop': 'Drop file here or click to select',
    'eingabe.csv.hint': 'Supports CSV with header row. Max size 5 MB.',
    'eingabe.csv.selected': 'Selected file',
    'eingabe.csv.uploading': 'Uploading...',
    'eingabe.csv.result': 'Import result',
    'eingabe.csv.success': 'Succeeded',
    'eingabe.csv.failed': 'Failed',
    'eingabe.csv.processed': 'Processed',
    'eingabe.csv.example': 'CSV example',
    'eingabe.manual.saved': 'Manual entry saved.',
    'eingabe.form.title': 'New transaction',
    'eingabe.form.subtitle': 'Enter manually or use the CSV upload on this page.',
    'eingabe.form.date': 'Date',
    'eingabe.form.merchant': 'Merchant / shop *',
    'eingabe.form.merchant.placeholder': 'e.g., Coop, Zalando, SBB',
    'eingabe.form.amount': 'Amount (CHF) *',
    'eingabe.form.rawCategory': 'Category (optional)',
    'eingabe.form.rawCategory.placeholder': 'e.g., Shopping, Groceries',
    'eingabe.form.rawCategory.hint': 'AI will classify automatically, but you can leave a hint here.',
    'eingabe.form.justification': 'Justification (optional)',
    'eingabe.form.justification.placeholder': 'Why did you make this purchase?',
    'eingabe.form.goal': 'Assign to savings goal (optional)',
    'eingabe.form.goal.placeholder': 'Select savings goal (optional)',
    'eingabe.form.allocate.placeholder': 'Amount as deposit (CHF)',
    'eingabe.form.allocate.hint': 'Optional: books an amount directly to the selected savings goal.',
    'eingabe.form.cancel': 'Cancel',
    'eingabe.form.submit': 'Save transaction',
    'eingabe.form.loading': 'Analyzing...',
    'verlauf.title': 'History',
    'verlauf.subtitle': 'All transactions with AI explanations and filters.',
    'verlauf.loading': 'Loading transactions...',
    'verlauf.newTransaction': 'New transaction',
    'verlauf.filters': 'Filters',
    'verlauf.search': 'Search',
    'verlauf.search.placeholder': 'e.g., Amazon, Netflix...',
    'verlauf.category': 'Category',
    'verlauf.category.all': 'All categories',
    'verlauf.type': 'Type',
    'verlauf.type.all': 'All',
    'verlauf.type.income': 'Income',
    'verlauf.type.expense': 'Expenses',
    'verlauf.type.expenseOnly': 'Expenses only (-)',
    'verlauf.type.incomeOnly': 'Income only (+)',
    'verlauf.sort': 'Sort by',
    'verlauf.sort.dateDesc': 'Date (new → old)',
    'verlauf.sort.dateAsc': 'Date (old → new)',
    'verlauf.sort.amountDesc': 'Amount (high → low)',
    'verlauf.sort.amountAsc': 'Amount (low → high)',
    'verlauf.budget': 'Monthly budget',
    'verlauf.budget.set': 'Set budget',
    'verlauf.budget.flex': 'Monthly budget (flexible)',
    'verlauf.budget.used': 'Used',
    'verlauf.budget.remaining': 'Remaining',
    'verlauf.budget.over': 'Overrun',
    'verlauf.budget.dialog.title': 'Adjust budget',
    'verlauf.budget.dialog.input': 'Budget in CHF',
    'verlauf.save': 'Save',
    'verlauf.cancel': 'Cancel',
    'verlauf.table.empty': 'No transactions found.',
    'verlauf.table.emptyState': 'No transactions recorded yet.',
    'verlauf.table.addFirst': 'Add first transaction',
    'verlauf.table.noResults': 'No transactions for these filters.',
    'verlauf.table.saving': 'Saving...',
    'verlauf.impulseJustify.label': 'Explain impulse buy',
    'verlauf.impulseJustify.submit': 'Submit justification',
    'verlauf.impulseJustify.placeholder': 'Why was this purchase necessary or planned?',
    'verlauf.impulseBadge': 'Impulse buy',
    'verlauf.table.changeCategory': 'Change category',
    'verlauf.dateRange.from': 'From',
    'verlauf.dateRange.to': 'To',
    'verlauf.clearFilters': 'Reset filters',
    'verlauf.amount': 'Amount',
    'verlauf.basis': 'Basis',
    'verlauf.manual': 'manual',
    'verlauf.salary': 'Salary (60%)',
    'verlauf.auto': 'Auto (salary based)',
  },
};

const I18nContext = createContext<I18nContextValue | undefined>(undefined);

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const [lang, setLang] = useState<Lang>('de');

  useEffect(() => {
    const saved = typeof window !== 'undefined' ? (localStorage.getItem('lang') as Lang | null) : null;
    if (saved === 'en' || saved === 'de') {
      setLang(saved);
    }
  }, []);

  useEffect(() => {
    if (typeof window !== 'undefined') {
      localStorage.setItem('lang', lang);
      document.documentElement.lang = lang;
    }
  }, [lang]);

  const t = useMemo(
    () => (key: string, fallback?: string) => translations[lang]?.[key] ?? fallback ?? key,
    [lang]
  );

  const toggleLanguage = () => setLang((prev) => (prev === 'de' ? 'en' : 'de'));

  const value = useMemo(() => ({ lang, toggleLanguage, t }), [lang, t]);

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n() {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error('useI18n must be used within I18nProvider');
  return ctx;
}
